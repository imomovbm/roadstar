{% extends "users/layout.html" %}
{% load static %}

{% block main %}
<style>
  .locked-field {
    background-color: #f0f0f0 !important;
    color: #6c757d;
    border: 1px solid #ced4da;
  }
</style>
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css" rel="stylesheet" />

<main id="main" class="main">
  <div class="pagetitle">
    <h1>Shartnoma</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'contracts:index' %}">Asosiy</a></li>
        <li class="breadcrumb-item"><a href="{% url 'contracts:index' %}">Shartnomalar</a></li>
        <li class="breadcrumb-item active">Shartnoma</li>
      </ol>
    </nav>
  </div><!-- End Page Title -->

  <section class="section dashboard">
    <div class="row">
      <div class="card col-md-8">
        <div class="card-body">
          <h5 class="card-title">{% if contract %} {{ contract.code }} shartnomani o'zgartirish {% else %}Yangi shartnoma yaratish{% endif %}</h5>
              
              <div class="align-center">
                  <!-- Pills Tabs -->
                  <ul class="nav nav-pills nav-justified" id="pills-tab" role="tablist">
                    
                    <li class="nav-item" role="presentation">
                      <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home" type="button" role="tab" aria-controls="pills-home" aria-selected="true">Yuridik shaxs</button>
                    </li>

                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button" role="tab" aria-controls="pills-profile" aria-selected="false">Jismoniy shaxs</button>
                    </li>

                  </ul>
              </div>  

              <div class="tab-content pt-3">

                <div class="tab-pane fade show active">
                  
          <!-- Floating Labels Form -->
          <form class="row g-3" method="post" action="{% if contract %}{% url 'contracts:edit_contract' contract.pk %}{% else %}{% url 'contracts:create_contract_company' %}{% endif %}">
            {% csrf_token %}
            <input type="hidden" name="client_id" id="client_id" value="{{ client.id|default:'' }}">
            <div class="col-md-2 d-flex align-items-center gap-3">
              <input class="form-check-input" type="checkbox" id="yattCheck" name="is_yatt"
                     {% if client.pinfl_number_if_yatt %}checked{% endif %}>
              <label class="form-check-label" for="yattCheck">
                <span class="badge bg-success"><i class="bi bi-person"> YATT</i></span>
              </label>
            </div>
            
            <div class="col-md-8">
              <div class="form-floating">
                <input type="text" class="form-control" name="pinfl_number" id="pinfl_number"
                                    pattern="\d{14}"
                                    maxlength="14"
       value="{{ client.pinfl_number_if_yatt|default:'' }}" placeholder="JSHSHIR raqami" disabled>
                <label for="pinfl_number">JSHSHIR raqami</label>
                <small class="text-muted">JSHSHIR (14 raqam, masalan: 12345678901011)</small>
              </div>
            </div>
            <div class="col-md-2 d-flex align-items-center">
              <button type="button" class="btn btn-primary w-100" id="fetch-btn">
                <i class="bi bi-arrow-repeat fs-4"></i>
              </button>
              <div id="spinner" class="spinner-border text-primary ms-2" role="status" style="display: none;">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>  
            <div class="col-md-10">
              <div class="form-floating">
                <input type="text" class="form-control"
                      name="tin_number"
                      id="tin_number"
                      pattern="\d{9,10}"
                      maxlength="10"
                      title="INN 9 yoki 10 xonali raqam bo'lishi kerak"
                      value="{{ client.tin_number|default:'' }}"
                      placeholder="INN raqami"
                      required>
                <label for="tin_number">INN raqami</label>
                <small class="text-muted">INN 9 yoki 10 xonali raqam bo'lishi kerak</small>
              </div>
            </div>

          
            <div class="col-md-12">
              <div class="form-floating">
                <input type="text" class="form-control" name="client_name" id="client_name"
       value="{{ client.client_name|default:'' }}" placeholder="Yuridik shaxs nomi" required>
                <label for="client_name">Yuridik shaxs nomi</label>
              </div>
            </div>
            <div class="col-md-12">
              <div class="form-floating">
                <input type="text" class="form-control" name="address" id="address"
       value="{{ client.address|default:'' }}" placeholder="Yuridik shaxs adresi" required>
                <label for="address">Yuridik shaxs adresi</label>
              </div>
            </div>
            <div class="col-md-8">
              <div class="form-floating">
                <input type="text" class="form-control" name="account_number" id="account_number"
                                    maxlength="50"
                                    inputmode="numeric"
       value="{{ client.account_number|default:'' }}" placeholder="Hisob raqami" required>
                <label for="account_number">Hisob raqami</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <input type="text" class="form-control" name="mfo" id="mfo"
                                    pattern="\d{4,5,6}"
                                    maxlength="6"
                                    inputmode="numeric"
       value="{{ client.mfo|default:'' }}" placeholder="MFO" required>
                <label for="mfo">MFO</label>
              </div>
            </div>
            <div class="col-md-12">
              <div class="form-floating">
                <input type="text" class="form-control" name="bank_address" id="bank_address"
       value="{{ client.bank_address|default:'' }}" placeholder="Bank adresi" required>
                <label for="bank_address">Bank adresi</label>
              </div>
            </div>
            <div class="col-md-12">
              <div class="form-floating">
                <input type="text" class="form-control" name="phone_number" id="phone_number"
                pattern="\+998[0-9]{9}"
       value="{{ client.phone_number|default:'' }}" placeholder="Telefon" required>
                <label for="phone_number">Telefon</label>
                <small class="text-muted">+998XXXXXXXXX</small>
              </div>
            </div>
            <div class="col-md-12">
              <div class="form-floating">
                <input type="text" class="form-control" name="head_of_company" id="head_of_company"
       value="{{ client.head_of_company|default:'' }}" placeholder="Direktor" required>
                <label for="head_of_company">Direktor</label>
              </div>
            </div>
            <div class="col-md-12">
              <div class="form-floating">
                <input type="email" class="form-control" name="email" id="email"
            pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
       value="{{ client.email|default:'' }}" placeholder="Email">
                <label for="email">Email</label>
              </div>
            </div>
              <input type="hidden" id="verified" name="verified" value="{% if client.verified %}true{% endif %}">
            <div class="col-md-12">
              <div class="form-floating">
                <input type="text" class="form-control" name="manager" maxlength="64" value="{{ contract.manager|default:'' }}" placeholder="Menejer">
                <label for="manager">Menejer</label>
              </div>
            </div>          
<label class="form-label fw-bold">Tovarlarni kiriting</label>
                  <div id="item-container">
                    {% if contract %}
                      {% if contract.contract_items.exists %}
                        {% for ci in contract.contract_items.all %}
                            <div class="item-row row align-items-center g-2 mb-2">
                              <div class="col-auto">
                                <label class="fw-bold item-index">{{ forloop.counter }}</label>
                              </div>
                              <div class="col-md-5">
                                <select class="form-select product-select" name="product[]" data-cost="{{ ci.cost }}" required>
                                  <option value="" data-cost="">— Mahsulot tanlang —</option>
                                  {% for item in items %}
                                    <option value="{{ item.id }}" data-cost="{{ item.default_cost }}" {% if item.id == ci.item_id %}selected{% endif %}>{{ item.item_name }}</option>
                                  {% endfor %}
                                </select>
                              </div>
                              <div class="col-md-3">
                                <input type="text" class="form-control cost-input" name="cost[]" value="{{ ci.cost }}" placeholder="Narxi" required>
                              </div>
                              <div class="col-md-2">
                                <input type="text" class="form-control" name="amount[]" value="{{ ci.amount }}" placeholder="Soni" required>
                              </div>
                              <div class="col-auto d-flex gap-1">
                                <button type="button" class="btn btn-success add-item-btn"><i class="bi bi-plus-lg"></i></button>
                                <button type="button" class="btn btn-danger remove-item-btn"><i class="bi bi-trash"></i></button>
                              </div>
                            </div>
                        {% endfor %}
                      {% else %}
                            <div class="item-row row align-items-center g-2 mb-2">
                              <div class="col-auto">
                                <label class="fw-bold item-index">1</label>
                              </div>
                              <div class="col-md-5">
                                <select class="form-select product-select" name="product[]" required>
                                  <option value="" data-cost="">— Mahsulot tanlang —</option>
                                  {% for item in items %}
                                    <option value="{{ item.id }}" data-cost="{{ item.default_cost }}">{{ item.item_name }}</option>
                                  {% endfor %}
                                </select>
                              </div>
                              <div class="col-md-3">
                                <input type="text" class="form-control cost-input" name="cost[]" placeholder="Narxi" required>
                              </div>
                              <div class="col-md-2">
                                <input type="text" class="form-control" name="amount[]" value="1" placeholder="Soni" required>
                              </div>
                              <div class="col-auto d-flex gap-1">
                                <button type="button" class="btn btn-success add-item-btn"><i class="bi bi-plus-lg"></i></button>
                                <button type="button" class="btn btn-danger remove-item-btn"><i class="bi bi-trash"></i></button>
                              </div>
                            </div>
                      {% endif %}
                    {% else %}
                        <div class="item-row row align-items-center g-2 mb-2">
                          <div class="col-auto">
                            <label class="fw-bold item-index">1</label>
                          </div>
                          <div class="col-md-5">
                            <select class="form-select product-select" name="product[]" required>
                              <option value="" data-cost="">— Mahsulot tanlang —</option>
                              {% for item in items %}
                                <option value="{{ item.id }}" data-cost="{{ item.default_cost }}">{{ item.item_name }}</option>
                              {% endfor %}
                            </select>
                          </div>
                          <div class="col-md-3">
                            <input type="text" class="form-control cost-input" name="cost[]" placeholder="Narxi" required>
                          </div>
                          <div class="col-md-2">
                            <input type="text" class="form-control" name="amount[]" value="1" placeholder="Soni" required>
                          </div>
                          <div class="col-auto d-flex gap-1">
                            <button type="button" class="btn btn-success add-item-btn"><i class="bi bi-plus-lg"></i></button>
                            <button type="button" class="btn btn-danger remove-item-btn"><i class="bi bi-trash"></i></button>
                          </div>
                        </div>
                    {% endif %}
                    
                  </div>
            <div class="text-center">
              <input type="checkbox" name="is_public" value="true" {% if contract.is_public %}checked disabled{% endif %}> QR kod generatsiya qilish           
            </div>
            <div class="text-center">
              <button type="submit" class="btn btn-primary">{% if contract %}Saqlash{% else %}Yaratish{% endif %}</button>
              <button type="reset" class="btn btn-secondary">Tozalash</button>
              <button type="button" class="btn btn-warning" id="edit-btn">Tahrirlash</button>
            </div>
          </form>
</div>
              
<!-- 1 tab ends -->
 <!-- 2 tab -->
                <div class="tab-pane fade">

                </div>
<!-- 2 tab ends -->

              </div><!-- End Pills Tabs -->


            



        </div>
      </div>
    </div>
  </section>
</main>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const yattCheckbox = document.getElementById("yattCheck");
    const pinflInput = document.getElementById("pinfl_number");

    function togglePinflInput() {
      pinflInput.disabled = !yattCheckbox.checked;
    }

    // Run initially
    togglePinflInput();

    // Toggle when checkbox changes
    yattCheckbox.addEventListener("change", togglePinflInput);
  });
</script>

<script>  
  let maxItems = 15;

  function initializeSelect2(el) {
    el.select2({
      placeholder: "Mahsulotni tanlang",
      width: '100%',
      theme: 'bootstrap4',
      allowClear: true
    });
  }

  $(document).ready(function () {
    initializeSelect2($('.product-select'));

    $('#item-container').on('click', '.add-item-btn', function () {
      const $lastRow = $('#item-container .item-row').last();
    
      // 1) Tear down the Select2 on the row you’re about to clone
      $lastRow.find('select.product-select').select2('destroy');
    
      // 2) Clone the now-plain row
      const $clone = $lastRow.clone(false, false);
    
      // 3) Re-initialize Select2 on both original & clone
      initializeSelect2($lastRow.find('select.product-select'));
      initializeSelect2($clone.find('select.product-select'));
    
      // 4) Reset values on the clone
      const newIndex = $('.item-row').length + 1;
      $clone.find('.item-index').text(newIndex);
      $clone.find('select').val(null).trigger('change');
      $clone.find('.cost-input').val('');
      $clone.find('input[name="amount[]"]').val('1');
    
      // 5) Append
      $('#item-container').append($clone);
    });
    

    $('#item-container').on('select2:select', '.product-select', function (e) {
      const selectedOption = e.params.data.element;
      const cost = selectedOption.getAttribute('data-cost') || "";
      $(this).closest('.item-row').find('.cost-input').val(cost);
    });

    $('#item-container').on('select2:clear', '.product-select', function () {
      $(this).closest('.item-row').find('.cost-input').val('');
    });
              // Remove item row
          $('#item-container').on('click', '.remove-item-btn', function () {
            if ($('.item-row').length > 1) {
              $(this).closest('.item-row').remove();

              // Re-number remaining rows
              $('.item-index').each(function (i) {
                $(this).text((i + 1));
              });
            } else {
              alert("Kamida 1 ta tovar qolishi kerak.");
            }
          });
  });
</script>
<script>
  const fieldsToLockLocal = ['tin_number' ,'client_name', 'address', 'account_number', 'mfo', 'bank_address' , 'phone_number', 'email', 'head_of_company'];
  const fieldsToLock = ['client_name', 'address', 'phone_number', 'email', 'head_of_company'];
  const editBtn = document.getElementById('edit-btn');
  const yattCheckbox = document.getElementById('yattCheck');
  const spinner = document.getElementById('spinner');

  document.getElementById('fetch-btn').addEventListener('click', async function () {
    const isYatt = yattCheckbox.checked;
    let idValue = '';

    if (isYatt) {
      idValue = document.getElementById('pinfl_number').value;
      if (!idValue) {
        alert("Iltimos, JSHSHIR kiriting.");
        return;
      }
    } else {
      idValue = document.getElementById('tin_number').value;
      if (!idValue) {
        alert("Iltimos, INN kiriting.");
        return;
      }
    }

    spinner.style.display = 'inline-block';

    try {
      // First try to fetch from our database
      const localResponse = await fetch(`/users/api/check-client/?id=${idValue}`);
      const localData = await localResponse.json();

      if (localData.exists) {
        // Client found in our DB
        document.getElementById('tin_number').value = localData.tin_number || "";
        document.getElementById('client_name').value = localData.name || "";
        document.getElementById('address').value = localData.address || "";
        document.getElementById('account_number').value = localData.account_number || "";
        document.getElementById('mfo').value = localData.mfo || "";
        document.getElementById('bank_address').value = localData.bank_address || "";
        document.getElementById('phone_number').value = localData.phone_number || "";
        document.getElementById('head_of_company').value = localData.head_of_company || "";
        document.getElementById('email').value = localData.email || "";
        document.getElementById('verified').value = localData.verified;
        document.getElementById('client_id').value = localData.id;
        $('.product-select, .cost-input, input[name="amount[]"]').prop('disabled', false);
        alert(`Mijoz topildi (${localData.type}): ${localData.name}`);
        // Lock fields
        fieldsToLockLocal.forEach(id => {
          const field = document.getElementById(id);
          field.setAttribute('readonly', true);
          field.classList.add('locked-field');
        });
        
        editBtn.textContent = "Tahrirlash";
        editBtn.dataset.mode = "edit";
        return;
      }

      // If not found in our DB, fetch from external API
      let url = "";
      if (isYatt) {
        url = `/users/api/fetch-company/?pinfl=${idValue}`;
      } else {
        url = `/users/api/fetch-company/?tin=${idValue}`;
      }

      const externalResponse = await fetch(url);
      if (!externalResponse.ok) {
        alert("Ma'lumot topilmadi!");
        return;
      }

      const externalData = await externalResponse.json();

      if (isYatt) {
        const head = externalData.entrepreneurshipDirector || {};
        const fullName = [head.lastName, head.firstName, head.middleName].filter(Boolean).join(" ");
        document.getElementById('head_of_company').value = fullName;

        document.getElementById('client_name').value = `"${fullName}" ${externalData.formName?.uz || ""}`;
        document.getElementById('tin_number').value = externalData.tin || "";
        document.getElementById('address').value = externalData.entrepreneurshipAddress?.address || "";
        document.getElementById('phone_number').value = externalData.phoneNumber || "";
      } else {
        document.getElementById('client_name').value = externalData.company?.name || "";
        document.getElementById('address').value = externalData.company?.streetName || "";
        
        const companyPhone = externalData.companyContact?.phone;
        const directorPhone = externalData.directorContact?.phone;
        document.getElementById('phone_number').value = companyPhone || directorPhone || "";

        const companyEmail = externalData.companyContact?.email;
        const directorEmail = externalData.directorContact?.email;
        document.getElementById('email').value = companyEmail || directorEmail || "";

        const director = externalData.director;
        if (director) {
          const fullName = [director.lastName, director.firstName, director.middleName].filter(Boolean).join(" ");
          document.getElementById('head_of_company').value = fullName;
        }
      }

      document.getElementById('verified').value = true;

      // Lock fields
      fieldsToLock.forEach(id => {
        const field = document.getElementById(id);
        field.setAttribute('readonly', true);
        field.classList.add('locked-field');
      });

      editBtn.textContent = "Tahrirlash";
      editBtn.dataset.mode = "edit";

    } catch (error) {
      console.error("Xatolik:", error);
      alert("Ma'lumot olishda xatolik yuz berdi.");
    } finally {
      spinner.style.display = 'none';
    }
  });

  // Toggle editable fields
  editBtn.addEventListener('click', function () {
    const isEditMode = editBtn.dataset.mode !== "locked";

    fieldsToLock.forEach(id => {
      const field = document.getElementById(id);
      if (isEditMode) {
        field.removeAttribute('readonly');
        field.classList.remove('locked-field');
      } else {
        field.setAttribute('readonly', true);
        field.classList.add('locked-field');
      }
    });

    editBtn.textContent = isEditMode ? "Qayta qulflash" : "Tahrirlash";
    editBtn.dataset.mode = isEditMode ? "locked" : "edit";
  });
</script>
{% endblock main %}
